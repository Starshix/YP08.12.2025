{% extends 'base.html' %}
{% load static %}

{% block title %}Панель контент-менеджера - GearLock{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-primary-gradient text-white py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="icon-lg bg-white text-about rounded-3 me-3">
                                <i class="fas fa-edit fs-3"></i>
                            </div>
                            <div>
                                <h1 class="h3 fw-bold mb-1">Панель контент-менеджера</h1>
                                <p class="mb-0 opacity-90">Добро пожаловать, {{ user.first_name|default:user.username }}!</p>
                            </div>
                        </div>
                        <div>
                            <span class="badge bg-white text-about">Обновлено: {% now "H:i" %}</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <p class="lead mb-0">Управляйте товарами, категориями и контентом интернет-магазина GearLock</p>
                </div>
            </div>
        </div>
    </div>

    
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-hover h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="icon-xl bg-primary-gradient text-white rounded-circle">
                                <i class="fas fa-box fs-3"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted text-uppercase mb-1">Всего товаров</h6>
                            <h2 class="fw-bold mb-0">{{ stats.total_products }}</h2>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="{% url 'catalog:product_list' %}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-eye me-1"></i> Просмотреть все
                    </a>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-hover h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="icon-xl bg-success-gradient text-white rounded-circle">
                                <i class="fas fa-tags fs-3"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted text-uppercase mb-1">Категорий</h6>
                            <h2 class="fw-bold mb-0">{{ stats.total_categories }}</h2>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="{% url 'catalog:category_list' %}" class="btn btn-sm btn-outline-success w-100">
                        <i class="fas fa-folder me-1"></i> Управление
                    </a>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-hover h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="icon-xl bg-info-gradient text-white rounded-circle">
                                <i class="fas fa-check-circle fs-3"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted text-uppercase mb-1">В наличии</h6>
                            <h2 class="fw-bold mb-0">{{ stats.in_stock }}</h2>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="{% url 'catalog:product_list' %}?stock=in_stock" class="btn btn-sm btn-outline-info w-100">
                        <i class="fas fa-filter me-1"></i> Показать
                    </a>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-hover h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="icon-xl bg-warning-gradient text-white rounded-circle">
                                <i class="fas fa-exclamation-triangle fs-3"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted text-uppercase mb-1">Нет в наличии</h6>
                            <h2 class="fw-bold mb-0">{{ stats.out_of_stock }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="row">
        
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-history text-about me-2"></i>
                            Последние добавленные товары
                        </h5>
                        <a href="{% url 'catalog:product_create' %}" class="btn btn-primary" id="contnentbtn">
                            <i class="fas fa-plus me-1"></i> Добавить товар
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0" style="width: 70px;">Фото</th>
                                    <th class="border-0">Название</th>
                                    <th class="border-0">Категория</th>
                                    <th class="border-0">Цена</th>
                                    <th class="border-0">Наличие</th>
                                    <th class="border-0">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in recent_products %}
                                <tr class="hover-row">
                                    <td>
                                        <div class="product-thumbnail">
                                            {% if product.image %}
                                                <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                                                     class="rounded-2" style="width: 60px; height: 60px; object-fit: cover;">
                                            {% else %}
                                                <div class="bg-light rounded-2 d-flex align-items-center justify-content-center" 
                                                     style="width: 60px; height: 60px;">
                                                    <i class="fas fa-car text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <a href="{% url 'catalog:product_detail' product.slug %}" class="text-decoration-none text-dark fw-bold">
                                            {{ product.name|truncatechars:30 }}
                                        </a>
                                        <div class="text-muted small">Арт: {{ product.sku|default:"—" }}</div>
                                    </td>
                                    <td>
                                        {% if product.category %}
                                            <span class="badge bg-secondary bg-gradient">{{ product.category.name }}</span>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="fw-bold text-about">{{ product.price }} ₽</div>
                                        {% if product.old_price %}
                                            <div class="text-danger small"><s>{{ product.old_price }} ₽</s></div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-success small mt-1"><i class="fas fa-circle"></i> Активен</div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'catalog:product_detail' product.slug %}" 
                                               class="btn btn-outline-primary" title="Просмотр">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'catalog:product_update' product.slug %}" 
                                               class="btn btn-outline-success" title="Редактировать">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="post" action="{% url 'catalog:product_delete' product.slug %}" 
                                                  class="d-inline" onsubmit="return confirm('Удалить товар {{ product.name }}?')">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-outline-danger" title="Удалить">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="py-4">
                                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted mb-3">Товаров пока нет</h5>
                                            <a href="{% url 'catalog:product_create' %}" class="btn btn-primary">
                                                <i class="fas fa-plus me-2"></i> Добавить первый товар
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% if recent_products %}
                <div class="card-footer bg-light border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small text-muted">
                            Показано {{ recent_products|length }} из {{ stats.total_products }} товаров
                        </div>
                        <a href="{% url 'catalog:product_list' %}" class="btn btn-outline-primary btn-sm">
                            Все товары <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        
        <div class="col-lg-4">
            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0 py-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-bolt text-about me-2"></i>
                        Быстрые действия
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-3">
                        <a href="{% url 'catalog:product_create' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus me-2"></i> Добавить товар
                        </a>
                        <a href="{% url 'catalog:category_create' %}" class="btn btn-success btn-lg">
                            <i class="fas fa-tags me-2"></i> Создать категорию
                        </a>
                        <a href="{% url 'catalog:product_list' %}" class="btn btn-info btn-lg">
                            <i class="fas fa-list me-2"></i> Все товары
                        </a>
                        <a href="{% url 'catalog:category_list' %}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-folder me-2"></i> Все категории
                        </a>
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-tags text-about me-2"></i>
                            Категории товаров
                        </h5>
                        <span class="badge bg-primary">{{ stats.total_categories }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="category-tree">
                        {% for category in categories %}
                            {% if not category.parent %}
                            <div class="mb-2">
                                <a href="{% url 'catalog:product_list_by_category' category.slug %}" 
                                   class="text-decoration-none text-dark fw-bold d-flex align-items-center">
                                    <i class="fas fa-folder text-about me-2"></i>
                                    {{ category.name }}
                                    <span class="badge bg-light text-dark ms-auto">{{ category.product_count }}</span>
                                </a>
                                {% for child in category.children.all %}
                                <a href="{% url 'catalog:product_list_by_category' child.slug %}" 
                                   class="text-decoration-none text-muted d-block ps-4 mt-1">
                                    <i class="fas fa-folder-open me-2"></i>
                                    {{ child.name }}
                                    <span class="badge bg-light text-dark ms-auto">{{ child.product_count }}</span>
                                </a>
                                {% endfor %}
                            </div>
                            {% endif %}
                        {% empty %}
                        <div class="text-center py-3">
                            <i class="fas fa-tags fa-2x text-muted mb-3"></i>
                            <p class="text-muted mb-0">Категорий пока нет</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-light border-0">
                    <a href="{% url 'catalog:category_list' %}" class="btn btn-outline-about w-100">
                        Управление категориями
                    </a>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0 py-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-chart-pie text-about me-2"></i>
                        Статус системы
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Заполненность каталога</span>
                            <span class="small fw-bold text-about">{{ stats.catalog_fill_percentage }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: {{ stats.catalog_fill_percentage }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Товары с фото</span>
                            <span class="small fw-bold text-success">{{ stats.products_with_images }} из {{ stats.total_products }}</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {{ stats.products_with_images_percentage }}%"></div>
                        </div>
                    </div>

                    <div class="border-top pt-3">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="text-primary fw-bold">{{ stats.in_stock_percentage }}%</div>
                                    <div class="small text-muted">В наличии</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="text-warning fw-bold">{{ stats.out_of_stock_percentage }}%</div>
                                    <div class="small text-muted">Нет в наличии</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light border-0">
                    <div class="small text-muted">
                        <i class="fas fa-user me-1"></i> {{ user.get_full_name }}
                        <span class="float-end">
                            <i class="fas fa-clock me-1"></i> {% now "H:i" %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0 py-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-book text-about me-2"></i>
                        Руководство контент-менеджера
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <div class="icon-lg bg-primary bg-opacity-10  rounded-circle mb-3 mx-auto">
                                    <i class="fas fa-image fs-3"></i>
                                </div>
                                <h6 class="fw-bold mb-2">Изображения</h6>
                                <p class="small text-muted mb-0">Оптимальный размер: 800×800px. Формат: JPG, PNG, WebP</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <div class="icon-lg bg-success bg-opacity-10 text-success rounded-circle mb-3 mx-auto">
                                    <i class="fas fa-search fs-3"></i>
                                </div>
                                <h6 class="fw-bold mb-2">SEO оптимизация</h6>
                                <p class="small text-muted mb-0">Заполняйте заголовки, описания и ключевые слова для каждой страницы</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <div class="icon-lg bg-info bg-opacity-10 text-info rounded-circle mb-3 mx-auto">
                                    <i class="fas fa-boxes fs-3"></i>
                                </div>
                                <h6 class="fw-bold mb-2">Структура</h6>
                                <p class="small text-muted mb-0">Создавайте иерархию категорий для удобной навигации пользователей</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <div class="icon-lg bg-warning bg-opacity-10 text-warning rounded-circle mb-3 mx-auto">
                                    <i class="fas fa-chart-line fs-3"></i>
                                </div>
                                <h6 class="fw-bold mb-2">Аналитика</h6>
                                <p class="small text-muted mb-0">Следите за наличием товаров и своевременно обновляйте цены и статусы</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light border-0">
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'users:dashboard' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> На главный дашборд
                        </a>
                        <div>
                            <button onclick="window.print()" class="btn btn-outline-primary me-2">
                                <i class="fas fa-print me-2"></i> Печать отчета
                            </button>
                            <button class="btn btn-outline-success" id="exportReport">
                                <i class="fas fa-file-excel me-2"></i> Экспорт
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-file-export text-primary me-2"></i>
                    Экспорт данных
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Формат экспорта</label>
                    <select class="form-select" id="exportFormat">
                        <option value="csv">CSV (Excel)</option>
                        <option value="json">JSON</option>
                        <option value="pdf">PDF</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Период</label>
                    <select class="form-select" id="exportPeriod">
                        <option value="today">Сегодня</option>
                        <option value="week">За неделю</option>
                        <option value="month" selected>За месяц</option>
                        <option value="all">За все время</option>
                    </select>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeProducts" checked>
                    <label class="form-check-label" for="includeProducts">
                        Включить список товаров
                    </label>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Отмена
                </button>
                <button type="button" class="btn btn-primary" id="confirmExport">
                    Экспортировать
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Экспорт отчета
    const exportBtn = document.getElementById('exportReport');
    const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
    const confirmExportBtn = document.getElementById('confirmExport');
    
    exportBtn.addEventListener('click', function() {
        exportModal.show();
    });
    
    confirmExportBtn.addEventListener('click', function() {
        const format = document.getElementById('exportFormat').value;
        const period = document.getElementById('exportPeriod').value;
        const includeProducts = document.getElementById('includeProducts').checked;
        
        // Создаем CSV данные
        const data = [
            ['Отчет контент-менеджера GearLock'],
            ['Пользователь:', '{{ user.get_full_name }}'],
            ['Дата:', '{% now "d.m.Y H:i" %}'],
            ['Период:', period],
            [],
            ['Метрика', 'Значение'],
            ['Всего товаров', '{{ stats.total_products }}'],
            ['Категорий', '{{ stats.total_categories }}'],
            ['Товаров в наличии', '{{ stats.in_stock }}'],
            ['Нет в наличии', '{{ stats.out_of_stock }}'],
            ['Заполненность каталога', '{{ stats.catalog_fill_percentage }}%'],
            ['Товары с фото', '{{ stats.products_with_images }}'],
        ];
        
        // Добавляем товары если нужно
        if (includeProducts && {{ recent_products|length }} > 0) {
            data.push([], ['Последние добавленные товары:']);
            data.push(['Название', 'Артикул', 'Цена', 'Наличие']);
            {% for product in recent_products %}
            data.push([
                '{{ product.name }}',
                '{{ product.sku|default:"—" }}',
                '{{ product.price }} ₽',
                '{{ product.stock }} шт.'
            ]);
            {% endfor %}
        }
        
        // Создаем CSV файл
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        data.forEach(row => {
            csvContent += row.map(cell => `"${cell}"`).join(",") + "\r\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `content_report_${period}_{% now 'Y-m-d' %}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        exportModal.hide();
    });
    
    // Автоматическое обновление каждые 5 минут
    setTimeout(function() {
        window.location.reload();
    }, 300000);
});
</script>
{% endblock %}